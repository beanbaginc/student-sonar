#!/usr/bin/env ./node_modules/.bin/babel-node --presets env --plugins dedent

import Q from 'q';

import init from '../lib/init';
import schema from '../lib/schema';
import Slack from '../lib/slack';

function updateUser(user) {
    const deferred = Q.defer();

    if (user.is_bot) {
        deferred.resolve();
    } else {
        console.log('Saving data for %s (%s - %s)',
	            user.profile.real_name_normalized, user.name, user.id);

        try {
            let query = schema.User.findOneAndUpdate(
                { slack_user_id: user.id },
                {
                    email: user.profile.email,
                    slack_user_id: user.id,
                    slack_username: user.name,
                    name: user.profile.real_name_normalized,
                    avatar: user.profile.image_192,
                    timezone: user.tz
                },
                { upsert: true },
                deferred.makeNodeResolver());
        } catch(e) {
            deferred.reject(e);
        }
    }

    return deferred.promise;
}

init()
    .then(function(options) {
        const slack = new Slack(options.config);

        return slack.getUsers()
            .then(users => Promise.all(users.members.map(updateUser)));
    })
    .then(process.exit)
    .catch(console.error.bind(console));
